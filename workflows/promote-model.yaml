apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: promote-model
spec:
  entrypoint: promote-flow
  arguments:
    parameters:
    - name: source-environment
    - name: target-environment
    - name: model-version

  templates:
  - name: promote-flow
    steps:
      - - name: retag-image
          template: skopeo-retag
          arguments:
            parameters:
            - name: source-environment
              value: "{{workflow.parameters.source-environment}}"
            - name: target-environment
              value: "{{workflow.parameters.target-environment}}"
            - name: model-version
              value: "{{workflow.parameters.model-version}}"
      - - name: deploy
          template: trigger-deploy
          arguments:
            parameters:
            - name: environment
              value: "{{workflow.parameters.target-environment}}"
            - name: model-version
              value: "{{workflow.parameters.model-version}}"
      - - name: update-mlflow-alias
          template: set-mlflow-alias
          arguments:
            parameters:
            - name: model-version
              value: "{{workflow.parameters.model-version}}"
            - name: alias
              value: "{{workflow.parameters.target-environment}}"

  - name: skopeo-retag
    inputs:
      parameters:
      - name: source-environment
      - name: target-environment
      - name: model-version
    container:
      image: quay.io/skopeo/stable
      command: [sh, -c]
      args:
        - |
          set -eux
          echo "ðŸ” Retagging image:"
          echo "    source=project37-app:{{inputs.parameters.source-environment}}-1.0.{{inputs.parameters.model-version}}"
          echo "    target=project37-app:{{inputs.parameters.target-environment}}-1.0.{{inputs.parameters.model-version}}"
          skopeo copy \
            --src-tls-verify=false \
            --dest-tls-verify=false \
            docker://registry.kube-system.svc.cluster.local:5000/project37-app:{{inputs.parameters.source-environment}}-1.0.{{inputs.parameters.model-version}} \
            docker://registry.kube-system.svc.cluster.local:5000/project37-app:{{inputs.parameters.target-environment}}-1.0.{{inputs.parameters.model-version}}
          echo "âœ… Retag completed"

  - name: trigger-deploy
    inputs:
      parameters:
      - name: model-version
      - name: environment
    container:
      image: argoproj/argocd:v2.11.3
      command: [sh, -c]
      args:
        - |
          set -eux
          echo "ðŸš€ Deploying to {{inputs.parameters.environment}}:"
          echo "    model-version={{inputs.parameters.model-version}}"
          ARGOCD_PW=$(kubectl -n argocd get secret argocd-initial-admin-secret \
                       -o jsonpath='{.data.password}' | base64 -d)
          argocd login argocd-server.argocd.svc.cluster.local:443 \
            --username admin \
            --password "$ARGOCD_PW" \
            --insecure --grpc-web
          echo "â© Setting image.tag to {{inputs.parameters.environment}}-1.0.{{inputs.parameters.model-version}}"
          argocd app set project37-{{inputs.parameters.environment}} \
            --helm-set-string image.tag={{inputs.parameters.environment}}-1.0.{{inputs.parameters.model-version}}
          echo "â³ Syncing Argo CD app project37-{{inputs.parameters.environment}}"
          argocd app sync project37-{{inputs.parameters.environment}}
          echo "âœ… Deploy step completed"

  - name: set-mlflow-alias
    inputs:
      parameters:
      - name: model-version
      - name: alias
    script:
      image: python:3.11-slim
      command: [sh, -c]
      source: |
        set -eux
        echo "ðŸ”§ Updating MLflow alias:"
        echo "    model-version={{inputs.parameters.model-version}}"
        echo "    alias={{inputs.parameters.alias}}"
        pip install mlflow-skinny > /dev/null
        export MLFLOW_TRACKING_URI=http://mlflow.project37-platform.svc.cluster.local:8000
        # retry in case the registry is momentarily unavailable
        for i in 1 2 3 4 5; do
          if python - <<PY
import mlflow
client = mlflow.tracking.MlflowClient()
client.set_registered_model_alias(
    name="MovieRecModel",
    alias="{{inputs.parameters.alias}}",
    version="{{inputs.parameters.model-version}}"
)
PY
          then
            echo "âœ… Alias set successfully"
            exit 0
          fi
          echo "âš ï¸ Alias set attempt $i failed; retrying..."
          sleep 3
        done
        echo "âŒ Failed to update alias after retries"
        exit 1
